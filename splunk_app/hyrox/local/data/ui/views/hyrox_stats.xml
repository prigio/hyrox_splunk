<form>
  <label>Hyrox stats</label>
  <search>
    <query>index=main sourcetype=hyrox category=$CATEGORY$ event_occurrence="$OCCURRENCE$" division="$DIVISION$" | stats count</query>
    <earliest>0</earliest>
    <latest>now</latest>
    <sampleRatio>1</sampleRatio>
    <done>
      <set token="COMP_COUNT">$result.count$</set>
    </done>
  </search>
  <search>
    <query>index=main sourcetype=hyrox category=$CATEGORY$ event_occurrence="$OCCURRENCE$" division="$DIVISION$" | stats count</query>
    <earliest>0</earliest>
    <latest>now</latest>
    <sampleRatio>1</sampleRatio>
    <done>
      <set token="COMP_COUNT">$result.count$</set>
    </done>
  </search>
  <search id="hyrox_events">
    <query>index=main sourcetype=hyrox
|  stats count min(_time) as earliest max(_time) as latest by event_occurrence division category
| eval latest=latest+86400
| bucket span=1d earliest
| bucket span=1d latest</query>
    <earliest>0</earliest>
    <latest>now</latest>
  </search>
  <fieldset submitButton="false">
    <input type="text" token="YOU">
      <label>Your registered name</label>
      <default>Prigione, Paolo</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Your results</title>
      <table>
        <search>
          <query>sourcetype=hyrox name="$YOU$*"
| eval "finish time"=tostring(total_time,"duration")
| table name event_occurrence division category "finish time" place place_ak judge*</query>
          <earliest>0</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="YOUR_OCCURRENCE">$row.event_occurrence$</set>
          <set token="form.OCCURRENCE">$row.event_occurrence$</set>
          <set token="OCCURRENCE">$row.event_occurrence$</set>
          <set token="form.DIVISION">$row.division$</set>
          <set token="DIVISION">$row.division$</set>
          <set token="form.CATEGORY">$row.category$</set>
          <set token="CATEGORY">$row.category$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Compare your performance to others</title>
      <input type="dropdown" token="OCCURRENCE">
        <label>Event occurrence</label>
        <fieldForLabel>event_occurrence</fieldForLabel>
        <fieldForValue>event_occurrence</fieldForValue>
        <choice value="*">Any</choice>
        <search base="hyrox_events">
          <query> dedup event_occurrence |  sort +earliest</query>
        </search>
      </input>
      <input type="dropdown" token="CATEGORY">
        <label>Category</label>
        <fieldForLabel>category</fieldForLabel>
        <fieldForValue>category</fieldForValue>
        <search base="hyrox_events">
          <query> dedup category |  sort +category</query>
        </search>
      </input>
      <input type="dropdown" token="DIVISION">
        <label>Division</label>
        <fieldForLabel>division</fieldForLabel>
        <fieldForValue>division</fieldForValue>
        <search base="hyrox_events">
          <query> dedup division |  sort +division</query>
        </search>
        <choice value="*">any</choice>
      </input>
      <chart depends="$COMP_COUNT$">
        <title>Comparing your performance at $YOUR_OCCURRENCE$ to other $COMP_COUNT$ performances at $OCCURRENCE$</title>
        <search>
          <query>index=main sourcetype=hyrox category=$CATEGORY$ event_occurrence="$OCCURRENCE$" division="$DIVISION$"
| stats p10(splits.*) as top10pct.* p25(splits.*) as top25pct.* p50(splits.*) as median.* p75(splits.*) as bot25pct.* p90(splits.*) as bot10pct.* p99(splits.*) as bot1pct.*
|  appendcols 
    [ search index=main sourcetype=hyrox event_occurrence="$YOUR_OCCURRENCE$" name="$YOU$*" | table splits.* | rename splits.* as you.*]
    | untable division metric value
| rex field=metric "(?&lt;placement&gt;[^\.]+)\.(?&lt;split&gt;.+)"
| xyseries split placement value
| table split top10pct top25pct median bot25pct bot10pct bot1pct you</query>
          <earliest>0</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.axisLabelsY.majorUnit">300</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">seconds per split</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.maximumNumber">1200</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.markerSize">6</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">you</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.showMarkers">1</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"top10pct":0x65a637, "top25pct":0xa2cc3e, "median":0xf2b827, "bot25pct":0xed8440, "bot10pct":0xd93f3c, "bot1pct":0x262626,  "you":0x6db7c6}</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
      <table>
        <title>Details of your performance at $YOUR_OCCURRENCE$</title>
        <search>
          <query>index=main sourcetype=hyrox 
          ((category=$CATEGORY$ event_occurrence="$OCCURRENCE$" division="$DIVISION$") 
          OR (event_occurrence="$YOUR_OCCURRENCE$" name="$YOU$*"))
| eval name=if(match(name,"$YOU$*") and event_occurrence="$YOUR_OCCURRENCE$", "you", "others")
| table name total_time splits.*
| rename splits.* as * total_time as "Finish time"
| untable name split value
| sort +split +value
| streamstats count as seq by split
| eventstats count as tot min(value) as best_time by split
| search name="you"
| eval time_diff = value - best_time
| rename value as your_time
| eval your_time=tostring(your_time,"duration"), 
       best_time=tostring(best_time,"duration"),
       your_ranking = seq . "/" . tot
| table split your_time your_ranking best_time time_diff
</query>
          <earliest>0</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
      </table>
    </panel>
  </row>
</form>